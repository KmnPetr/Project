#!/bin/bash

echo "//////////////////Начата maven сборка./////////////////////////////////////////////////"
mvn clean package
echo "//////////////////Maven сборка окончена.///////////////////////////////////////////////"

echo "//////////////////Начата сборка образа 'kmnpetr/project'///////////////////////////////"
docker build -t kmnpetr/project .
echo "//////////////////Cборка образа 'kmnpetr/project' окончена/////////////////////////////"

echo "//////////////////Push образа 'kmnpetr/project' на dockerhub///////////////////////////"
docker push kmnpetr/project:latest
echo "//////////////////Push образа 'kmnpetr/project' на dockerhub окончена./////////////////"

echo "//////////////////Остановка докер контейнеров./////////////////////////////////////////"
ssh root@46.8.19.22 << EOF
docker compose -f /home/docker-compose.yml down
EOF
echo "//////////////////Контейнеры остановлены.//////////////////////////////////////////////"

echo "//////////////////Копирование файла.///////////////////////////////////////////////////"
scp ./docker-compose.yml root@46.8.19.22:/home
echo "//////////////////Копирование завершено.///////////////////////////////////////////////"

echo "//////////////////Запуск docker-compose.yml.///////////////////////////////////////////"
ssh root@46.8.19.22 << EOF
docker compose -f /home/docker-compose.yml up -d
EOF
echo "//////////////////docker-compose.yml запущен.//////////////////////////////////////////"

